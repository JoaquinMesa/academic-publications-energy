# Triad Forecasting System

## Scientific Background (Goals & System)
The recent energy policy changes aim to substantially increase renewable energy generation and reduce carbon emissions. Renewable generation presents the challenge of depending on meteorological conditions (solar and wind) with a chaotic nature. Reducing the electricity demand peaks is a key issue for Demand Response (DR) programs and is the next step for reducing carbon emissions, thus less power will have to be generated by coal and gas. 

Faruqui and Sergici survey 15 recent empirical assessments of residential dynamic pricing programs, most conducted in the US after the year 2000. According to their survey, Time-of-Use (ToU) tariffs induce a reduction in peak consumption that ranges from 3% to 6% and Critical Peak Pricing (CPP) has the effect of decreasing peak usage by between 13% and 20%. Therefore, there is a need for more flexible systems and the application of Demand Response interventions (peak demand forecasting).

### Goal
To forecast high demand electricity peaks for Demand Side Response (DSR) interventions.

### System Design
A system is designed, comprised of:
- Long-Short-Term-Memory Network (Forecasting)
- Smoothing Exponential Moving Average (Filters)

This system aims to be used in Demand Response programs and is tested on a case study: The UK Triad forecast.

## Triad Background
The Triad refers to the three half-hour settlement periods with the highest system demand between November and February, separated by at least ten clear days. National Grid uses the Triad to determine TNUoS charges for customers with half-hour metering.

### Steps for Triad Calculation
1. **Calculate the half-hourly system demand between November and February.**
   - Sum up all Supplier BMUs volumes (i.e., sum all BMUs starting 2_).
   - Add any other BMUs taking demand, excluding Interconnectors (i.e., adding BMUs starting E_, T_, or M_).
2. **Select the highest half-hour system demand.** This period is one of the three (Triad) periods.
3. **Set aside 10 Clear Days on both sides of the selected period.**
4. **Select the highest half-hour system demand from the remaining data.** This period is the second Triad period.
5. **Set aside 10 Clear Days on both sides of the second Triad period.**
6. **Select the highest half-hour system demand from the remaining data.** This period is the third Triad period.

Triad information for the period 2014/2015 is illustrated with Triad days in red, ten days separation in green, and the rest of the days in blue.

## System Detailed Description
### High-Level View
The system consists of three main components: Forecasting -> Peaks Extraction -> Filters. The peaks are extracted from the demand forecast values, and then filters are applied to these peaks.

### Components
1. **LSTM Forecasting**: Provides SD forecasted values for the next 48 settlement periods using 40 concatenated cells, 250 iterations, and a batch size of 6 days of data.
2. **Peak Extraction**: Extracts the maximum demand peak of the day and adds it to a vector with previous forecast peaks. Weekends and Christmas periods are excluded.
3. **Filters**: Applies two Exponential Moving Averages (EMAs) multiplied by a factor (3.5% and 4% for soft and hard filters, respectively).

### Long-Short Term Memory (LSTM)
LSTM manages two state vectors: the forget gate, input gate, and output gate control various parts of the long-term and short-term states. The logistic function transformation (σ) is applied after a fully connected neural network set.

### Exponential Moving Average (EMA)
EMA is a modified moving average with more weight given to the latest data, acting as a classifier. The formula for EMA is:

\[ S_t = α y_{t-1} + (1-α) S_{t-1} \]

Where:
- \( S_t \): Value of the EMA for t = now.
- \( α \): Smoothing constant.
- \( y_{t-1} \): Actual observation for t - 1.
- \( S_{t-1} \): Value of the EMA for t - 1.

### Model Evaluation
The Root Mean Square Error (RMSE) is used as the accuracy evaluator:

\[ RMSE = \sqrt{\frac{1}{N} \sum_{j=1}^{N} (y_j - \hat{y}_j)^2} \]

Where:
- \( N \): Number of values.
- \( y_j \): Actual value.
- \( \hat{y}_j \): Forecasted value.

### Conclusions
Triad signals result in switching off equipment and running generators. Filter factors (3.5% and 4%) define the level of risk. Circumstances like the P350 amendment may affect forecasting accuracy. Future systems require flexible, low-cost interventions to reduce carbon emissions. The UK energy market's DSR interventions are relevant to international markets, providing a concise, accurate, and computationally light forecasting approach.

## Triad App Daily Working Example and Configuration
The main purpose of this application is to generate signals for Triad periods. The system forecasts the next day's national electricity demand and applies boundaries to call Triads (1) or no-Triads (0). The inputs are fetched from the ELEXON API and processed to produce outputs such as DateStamp, PeriodID, SoftEMA/HardEMA, LSTMDemandForecast, and SoftSignals/HardSignals.

### Inputs
Data streams from ELEXON:
- National Demand Forecast (NDF)
- Transmission Demand Forecast (TSDF)
- Solar generation forecast
- Wind generation forecast

### Output
- **LSTMDemandForecast**: Forecasted demand data for the next day.
- **SoftEMA/HardEMA**: Boundary values for the whole day.
- **SoftSignals/HardSignals**: Binary signals indicating Triads or no-Triads.

### Inputs Relationship with the Output
The model forecasts SF/R1/R2 data (settled demand) and considers the relationship between aggregated renewables generation and settled data.

### Results
A summary image illustrates how the forecast and filters work together, comparing with actual demand.

## Model Parameters Description and Configuration
Configuration parameters in the `config.ini` file include:
- **NIterations**: Number of iterations (default 250).
- **AlphaSoft/AlphaHard**: EMA smoothing constants (default 0.001).
- **Lag**: Number of values for moving averages (default 35).
- **PercSoft/PercHard**: Boundary push values (default 3.5% and 4%).

## Database Components
Data is stored in SQL Server databases. Four main tables are used:
1. **Weekdays_LSTMPrediction**: Data for EMA calculations.
2. **UK_INDO_DemandData**: Training data.
3. **TriadPrediction**: Daily prediction outputs.
4. **LSTM_ModelParameters**: Parameters history.

## List of Files and Daily Runs
The system runs daily at 8:00 AM during the Triad season (1st November to 28th February, excluding 23rd December to 2nd January). The main script is `Main.py`.

### Scripts List
- **API_ELEXON.py**: Functions to extract data from the API.
- **DB.py**: Database connection functions.
- **Main.py**: Main script for daily runs.
- **Parameters.py**: Fetches parameters from databases and settings.
- **TrainingLoader.py**: Loads training data (currently not in use).
- **TRIADfunctions.py**: Adjacent functions for other scripts.
- **config.ini**: Configuration file.

### Initial Set-Up
`Settings.ini` and `dbo.LSTM_ModelParameters` contain modifiable variables. At the beginning of a new season, clear the `dbo.Weekdays_LSTMPrediction` table to ensure initialization. Training data is manually added to `dbo.UK_INDO_DemandData`.

## Libraries and Tensorflow Set-Up Instructions on Windows
The application runs on Python 3.6. Required libraries:
- sqlalchemy
- urllib
- pandas
- numpy
- datetime
- configparser
- Tensorflow
- keras

### Tensorflow Installation
1. Install Anaconda 3.
2. Create a virtual environment:
   ```sh
   conda create -n <virtual_environment_name> python=<version>